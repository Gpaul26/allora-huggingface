version: "3.8"
services:
  inference:
    container_name: inference-hf
    build:
      context: .
      dockerfile: Dockerfile_inference
    command: python -u /app/app.py
    ports:
      - "8000:8000"

  init_huggingface-walkthrough:
    container_name: init_huggingface-walkthrough
    image: alloranetwork/allora-chain:latest
    volumes:
      - ./data:/data
    entrypoint: /data/scripts/init.sh

  huggingface-walkthrough:
    container_name: huggingface-walkthrough
    environment:
      - HUGGINGFACE_TOPIC_ID=4     #! Pre created topic: BTC 24h
      - BOOT_NODES_URL=https://raw.githubusercontent.com/allora-network/networks/main/allora-testnet-1/heads.txt
      - ALLORA_RPC=https://allora-rpc.testnet-1.testnet.allora.network:443
      - INFERENCE_API_ADDRESS=http://inference:8000
      - DATA_DIR=/data/worker
    build: .
    entrypoint:
      - "/bin/bash" 
      - "-c"
      - |
        set -ex

        # Define my public IP for dialback address
        MY_IP=$(curl -4 icanhazip.com)

        # Echo run the worker
        allora-node \
        --role=worker \
        --peer-db=$${DATA_DIR}/peer-database \
        --function-db=$${DATA_DIR}/function-database \
        --runtime-path=/app/runtime \
        --runtime-cli=bls-runtime \
        --workspace=$${DATA_DIR}/workspace \
        --private-key=$${DATA_DIR}/key/priv.bin \
        --boot-nodes=$(curl -Ls $${BOOT_NODES_URL}) \
        --allora-chain-home-dir=$${DATA_DIR}/.allorad \
        --allora-node-rpc-address=$${ALLORA_RPC} \
        --allora-chain-key-name=worker \
        --allora-chain-topic-id=$${HUGGINGFACE_TOPIC_ID} \
        --topic=allora-topic-$${HUGGINGFACE_TOPIC_ID}-worker \
        --dialback-address=$${MY_IP} \
        --dialback-port=9010 \
        --port=9010 \
        --log-level=debug
    volumes:
      - type: bind
        source: ./data
        target: /data
    env_file:
      - .env
    ports:
      - "9010:9010"           # Should match values of `--dialback-port`:`--port`
    depends_on:
      - init_huggingface-walkthrough